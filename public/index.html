<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Word Per Word - Origin: Mana Siege</title>
    <style>
        :root {
            --bg-color: #1a1a24; --panel-bg: #2a2a35; --primary: #4CAF50;
            --secondary: #2196F3; --danger: #f44336; --text-light: #f1f1f1;
            --text-muted: #aaa; --grid-bg: #333; --tile-bg: #e0e0e0;
            --tile-text: #111; --tile-selected: #ffc107; --system-msg: #ff9800;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); color: var(--text-light); margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        .container { width: 100%; max-width: 1100px; background-color: var(--panel-bg); border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); overflow: hidden; display: none; flex-direction: column; height: 90vh; position: relative; }
        .active-screen { display: flex; }
        
        .auth-box { margin: auto; text-align: center; padding: 40px; background-color: rgba(0,0,0,0.2); border-radius: 10px; width: 80%; max-width: 400px; }
        .auth-box h1 { margin-bottom: 20px; color: var(--primary); }
        .auth-box input { display: block; width: calc(100% - 20px); box-sizing: border-box; margin: 10px auto; padding: 10px; border-radius: 5px; border: none; }
        
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-secondary { background-color: var(--secondary); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-admin { background-color: #9c27b0; color: white; display: none; }
        button:hover { opacity: 0.8; }
        
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background-color: #222; border-bottom: 2px solid var(--primary); flex-wrap: wrap; gap: 10px; }
        .profile-info { display: flex; align-items: center; gap: 15px; }
        .profile-text h3 { margin: 0; }
        .profile-text p { margin: 5px 0 0 0; color: var(--text-muted); font-size: 14px; }
        .rank-badge { width: 50px; height: 50px; object-fit: contain; }
        .lobby-content { display: flex; flex: 1; overflow: hidden; }
        .left-panel { flex: 2; padding: 20px; display: flex; flex-direction: column; gap: 15px; border-right: 1px solid #444; overflow-y: auto;}
        .right-panel { flex: 1; display: flex; flex-direction: column; background-color: #1f1f28; }
        
        .play-menu { display: none; background: rgba(0,0,0,0.4); padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .play-menu-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 15px; }
        
        .leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 10px; background: rgba(0,0,0,0.2); border-radius: 5px; overflow: hidden;}
        .leaderboard-table th, .leaderboard-table td { padding: 10px; text-align: left; border-bottom: 1px solid #444; vertical-align: middle; }
        .leaderboard-table th { background-color: #111; color: var(--secondary); }
        .badge-cell { width: 60px; text-align: center; }

        .chat-box { flex: 1; display: flex; flex-direction: column; padding: 10px; overflow: hidden; }
        .chat-messages { flex: 1; overflow-y: auto; margin-bottom: 10px; padding: 10px; background-color: rgba(0,0,0,0.3); border-radius: 5px; font-size: 14px; word-wrap: break-word; }
        .chat-input-area { display: flex; }
        .chat-input-area input { flex: 1; padding: 10px; border-radius: 5px 0 0 5px; border: none; min-width: 0; }
        .chat-input-area button { margin: 0; border-radius: 0 5px 5px 0; }
        .msg-system { color: var(--system-msg); font-weight: bold; }
        
        #loadingScreen { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(26, 26, 36, 0.95); z-index: 50; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .spinner { border: 6px solid #333; border-top: 6px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .game-layout { display: flex; flex: 1; padding: 20px; gap: 20px; overflow: hidden; }
        .board-section { flex: 2; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .grid-6x6 { display: grid; grid-template-columns: repeat(6, 60px); grid-template-rows: repeat(6, 60px); gap: 5px; background-color: var(--grid-bg); padding: 10px; border-radius: 8px; margin-bottom: 20px; user-select: none; }
        .tile { background-color: var(--tile-bg); color: var(--tile-text); font-size: 24px; font-weight: bold; display: flex; justify-content: center; align-items: center; border-radius: 4px; cursor: pointer; box-shadow: 0 4px 0px #999; touch-action: manipulation; }
        .tile.selected { background-color: var(--tile-selected); box-shadow: 0 2px 0px #b28704; transform: translateY(2px); }
        .word-builder { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: center; }
        .current-word { font-size: 24px; letter-spacing: 2px; min-width: 150px; text-align: center; padding: 10px; background: #111; border-radius: 5px; min-height: 28px; }
        .side-section { flex: 1; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .player-list, .found-words { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; overflow-y: auto; flex: 1; }
        .timer { font-size: 32px; font-weight: bold; color: var(--danger); text-align: center; margin-bottom: 10px; }
        
        .spectator-views { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .spec-player { background: #222; padding: 10px; border-radius: 5px; border-left: 3px solid var(--secondary); }
        .spec-words { font-size: 12px; color: #ccc; margin-top: 5px; max-height: 80px; overflow-y: auto; }

        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; }
        .modal-content { background-color: var(--panel-bg); padding: 30px; border-radius: 10px; text-align: center; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .result-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #444; }
        
        #adminPanel { display: none; position: absolute; top: 5%; left: 5%; width: 90%; height: 90%; background: #1a1a24; border: 2px solid #9c27b0; border-radius: 10px; z-index: 200; flex-direction: column; padding: 20px; box-sizing: border-box; box-shadow: 0 0 20px #9c27b0; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #9c27b0; padding-bottom: 10px; margin-bottom: 15px; }
        .admin-body { display: flex; gap: 20px; flex: 1; overflow: hidden; }
        .admin-col { flex: 1; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; overflow-y: auto; }
        .admin-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #444; align-items: center; }

        @media (max-width: 768px) {
            body { align-items: flex-start; }
            .container { height: 100vh; border-radius: 0; }
            .lobby-content { flex-direction: column; }
            .left-panel { flex: 1; border-right: none; border-bottom: 2px solid #444; overflow-y: visible; }
            .right-panel { flex: 1; }
            .game-layout { flex-direction: column; overflow-y: auto; }
            .board-section { flex: none; }
            .grid-6x6 { grid-template-columns: repeat(6, 12vw); grid-template-rows: repeat(6, 12vw); gap: 1vw; }
            .tile { font-size: 6vw; }
            .side-section { flex: none; overflow: visible; }
            .player-list, .found-words { max-height: 200px; }
            .admin-body { flex-direction: column; }
        }
    </style>
</head>
<body>
    <audio id="bgmMenu" src="music/menu.mp3" loop></audio>
    <audio id="bgmGame" src="music/gameplay.mp3" loop></audio>

    <div id="authScreen" class="container active-screen">
        <div class="auth-box">
            <h1>Word Per Word</h1>
            <input type="text" id="usernameInput" placeholder="Username" />
            <input type="password" id="passwordInput" placeholder="Password" />
            <button class="btn-primary" onclick="login()">Login</button>
            <button class="btn-secondary" onclick="register()">Register</button>
            <p id="authMessage" style="color: var(--danger);"></p>
        </div>
    </div>

    <div id="lobbyScreen" class="container">
        <div class="header">
            <div class="profile-info">
                <img id="headerBadge" class="rank-badge" src="assets/e.png" alt="Rank Badge">
                <div class="profile-text">
                    <h3 id="profileUsername">Player</h3>
                    <p><span id="profileRank">Novice Scribe</span> | LP: <span id="profileLp">0</span></p>
                </div>
            </div>
            <div>
                <button id="adminBtn" class="btn-admin" onclick="openAdminPanel()">Admin Panel</button>
                <button class="btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>
        
        <div class="lobby-content">
            <div class="left-panel">
                <button class="btn-primary" style="font-size: 20px; padding: 15px;" onclick="togglePlayMenu()">PLAY NOW</button>
                
                <div id="playMenu" class="play-menu">
                    <div id="playMenuGrid" class="play-menu-grid">
                        <button class="btn-secondary" onclick="findMatch()">Find Ranked Match</button>
                        <button class="btn-secondary" style="background-color: #ff9800;" onclick="startAIMatch()">Play Solo (vs AI)</button>
                        
                        <div style="display: flex; gap: 5px; flex-direction: column;">
                            <input type="text" id="customRoomPassword" placeholder="Optional Room Password..." style="padding: 10px; border-radius: 5px; border: none; background: rgba(255,255,255,0.1); color: white;" />
                            <button class="btn-primary" onclick="createCustomRoom()">Create Custom Room</button>
                        </div>
                    </div>

                    <div id="searchingState" style="display:none; padding: 15px;">
                        <h3 style="color: var(--secondary);">Searching for opponents...</h3>
                        <p style="font-size: 12px; color: var(--text-muted);">(Matchmaking limited to Â±200 LP)</p>
                        <button class="btn-danger" onclick="cancelSearch()">Cancel Search</button>
                    </div>

                    <div id="rankedWaitingRoom" style="display:none; background: #222; padding: 15px; border-radius: 5px;">
                        <h3 style="color: var(--primary);">Ranked Match Found!</h3>
                        <ul id="rankedWaitingPlayers" style="list-style: none; padding: 0; text-align: left; margin: 15px 0;"></ul>
                        <div style="display: flex; justify-content: center; gap: 10px;">
                            <button id="readyRankedBtn" class="btn-primary" onclick="readyRanked()">Ready Up</button>
                            <button class="btn-danger" onclick="leaveWaitingRoom()">Leave Room</button>
                        </div>
                    </div>

                    <div id="customMenuSection">
                        <hr style="border-color: #444; margin: 15px 0;">
                        <h4>Active Custom Rooms</h4>
                        <div id="roomList" style="text-align: left;"></div>
                        
                        <div id="roomSetup" style="display:none; background: #222; padding: 15px; border-radius: 5px; margin-top: 10px;">
                            <h3>Custom Room: <span id="customRoomIdText"></span></h3>
                            <ul id="customWaitingPlayers" style="list-style: none; padding: 0; text-align: left; margin: 15px 0;"></ul>
                            <p>Players: <span id="customPlayerCount">1</span>/4</p>
                            <div style="display: flex; justify-content: center; gap: 10px;">
                                <button class="btn-primary" onclick="startCustomGame()">Start Game</button>
                                <button class="btn-danger" onclick="leaveWaitingRoom()">Leave Room</button>
                            </div>
                        </div>
                    </div>
                </div>

                <h2>World Ranking</h2>
                <div style="overflow-x: auto;">
                    <table class="leaderboard-table">
                        <thead><tr><th class="badge-cell">Badge</th><th>Player</th><th>Rank</th><th>LP</th></tr></thead>
                        <tbody id="leaderboardBody"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="right-panel">
                <div class="chat-box">
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-input-area">
                        <input type="text" id="chatInput" placeholder="Type a message..." onkeypress="handleChatEnter(event)">
                        <button class="btn-primary" onclick="sendChat()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingScreen">
        <div class="spinner"></div>
        <h2 style="color: var(--primary);">Preparing Board...</h2>
        <p id="loadingPlayers" style="color: var(--text-muted);"></p>
    </div>

    <div id="gameScreen" class="container">
        <div class="game-layout">
            <div class="board-section">
                <div class="timer" id="gameTimer">2:00</div>
                <div class="grid-6x6" id="gameBoard"></div>
                <div class="word-builder" id="gameControls">
                    <div class="current-word" id="currentWordDisplay"></div>
                    <button class="btn-primary" onclick="submitWord()">Submit</button>
                    <button class="btn-secondary" onclick="clearWord()">Clear</button>
                </div>
                <p id="wordMessage" style="margin-top: 10px; font-weight: bold; min-height: 20px;"></p>
            </div>
            
            <div class="side-section">
                <div class="player-list">
                    <h3 id="opponentsTitle">Opponents</h3>
                    <ul id="gamePlayerList" style="list-style: none; padding: 0;"></ul>
                    <div id="spectatorViews" class="spectator-views" style="display: none;"></div>
                </div>
                <div class="found-words" id="myScoreSection">
                    <h3>My Score: <span id="myGameScore">0</span></h3>
                    <ul id="myFoundWordsList" style="list-style: none; padding: 0; color: var(--secondary);"></ul>
                </div>
                <button id="quitGameBtn" class="btn-danger" style="margin-top: auto;" onclick="quitGame()">Quit Game (Penalty)</button>
            </div>
        </div>
    </div>

    <div id="gameOverModal" class="modal">
        <div class="modal-content">
            <h1 style="color: var(--primary);">Match Concluded</h1>
            <h2>Final Results</h2>
            <div id="gameOverResults" style="margin-top: 20px; text-align: left;"></div>
            <button class="btn-primary" style="margin-top: 20px;" onclick="returnToLobby()">Return to Lobby</button>
        </div>
    </div>

    <div id="adminPanel">
        <div class="admin-header">
            <h2>Admin Control Panel (Kei)</h2>
            <button class="btn-danger" onclick="closeAdminPanel()">Close X</button>
        </div>
        <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
            <input type="text" id="adminBroadcastInput" placeholder="System Broadcast Message..." style="flex: 1; padding: 10px;">
            <button class="btn-secondary" onclick="adminBroadcast()">Broadcast</button>
        </div>
        <div class="admin-body">
            <div class="admin-col">
                <h3>Online Users</h3>
                <div id="adminUserList"></div>
            </div>
            <div class="admin-col">
                <h3>Active Matches</h3>
                <div id="adminRoomList"></div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentRoom = null;
        let myUsername = null;
        let isSpectator = false;

        const bgmMenu = document.getElementById('bgmMenu');
        const bgmGame = document.getElementById('bgmGame');
        bgmMenu.volume = 0.5;
        bgmGame.volume = 0.5;

        function playMenuMusic() {
            bgmGame.pause(); bgmGame.currentTime = 0;
            bgmMenu.play().catch(e => console.log("Audio play blocked until interaction."));
        }
        function playGameMusic() {
            bgmMenu.pause(); bgmMenu.currentTime = 0;
            bgmGame.play().catch(e => console.log("Audio play blocked until interaction."));
        }

        window.onload = () => {
            const savedUser = localStorage.getItem('wpw_user');
            const savedPass = localStorage.getItem('wpw_pass');
            if (savedUser && savedUser !== 'undefined' && savedPass) {
                socket.emit('reconnectUser', { username: savedUser, password: savedPass });
            } else {
                localStorage.removeItem('wpw_user');
            }
        };

        function register() {
            const u = document.getElementById('usernameInput').value;
            const p = document.getElementById('passwordInput').value;
            if(u && p) socket.emit('register', {username: u, password: p});
        }
        function login() {
            const u = document.getElementById('usernameInput').value;
            const p = document.getElementById('passwordInput').value;
            if(u && p) socket.emit('login', {username: u, password: p});
        }
        function logout() {
            socket.emit('logout');
            localStorage.removeItem('wpw_user');
            localStorage.removeItem('wpw_pass');
            myUsername = null;
            document.getElementById('authScreen').classList.add('active-screen');
            document.getElementById('lobbyScreen').classList.remove('active-screen');
            bgmMenu.pause();
        }

        socket.on('authSuccess', (data) => {
            myUsername = data.username;
            localStorage.setItem('wpw_user', data.username);
            const passInput = document.getElementById('passwordInput').value;
            if(passInput) localStorage.setItem('wpw_pass', passInput);
            
            document.getElementById('authMessage').innerText = '';
            document.getElementById('authScreen').classList.remove('active-screen');
            document.getElementById('lobbyScreen').classList.add('active-screen');
            
            updateProfileUI(data);
            
            if (myUsername === 'Kei') document.getElementById('adminBtn').style.display = 'inline-block';
            else document.getElementById('adminBtn').style.display = 'none';

            playMenuMusic();
            socket.emit('getLeaderboard');
            socket.emit('getRoomList');
        });

        socket.on('authError', (msg) => {
            document.getElementById('authMessage').innerText = msg;
            if (msg.includes("another tab") || msg.includes("expired")) {
                localStorage.removeItem('wpw_user');
                localStorage.removeItem('wpw_pass');
            }
        });
        
        socket.on('adminKicked', () => { 
            localStorage.removeItem('wpw_user'); 
            alert("You have been kicked by the Admin."); 
            window.location.reload(); 
        });

        function updateProfileUI(data) {
            document.getElementById('profileUsername').innerText = data.username;
            document.getElementById('profileRank').innerText = data.rank;
            document.getElementById('profileLp').innerText = data.lp;
            document.getElementById('headerBadge').src = `assets/${data.badge}`;
        }

        function sendChat() {
            const input = document.getElementById('chatInput');
            if (input.value.trim()) {
                socket.emit('sendChat', input.value.trim());
                input.value = '';
            }
        }
        function handleChatEnter(e) { if(e.key === 'Enter') sendChat(); }
        
        socket.on('receiveChat', (data) => {
            const box = document.getElementById('chatMessages');
            const isSystem = data.username === 'SYSTEM';
            const msgClass = isSystem ? 'msg-system' : '';
            box.innerHTML += `<div class="${msgClass}"><strong>[${data.rank}] ${data.username}:</strong> ${data.message}</div>`;
            box.scrollTop = box.scrollHeight;
        });

        socket.on('updateLeaderboard', (players) => {
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = '';
            players.forEach(p => {
                tbody.innerHTML += `<tr>
                    <td class="badge-cell"><img class="rank-badge" src="assets/${p.badge}" alt="Badge"></td>
                    <td><strong>${p.username}</strong></td>
                    <td>${p.rank}</td>
                    <td>${p.lp}</td>
                </tr>`;
            });
        });

        function togglePlayMenu() {
            const menu = document.getElementById('playMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            if (menu.style.display === 'block') socket.emit('getRoomList');
        }

        function findMatch() {
            document.getElementById('playMenuGrid').style.display = 'none';
            document.getElementById('customMenuSection').style.display = 'none';
            document.getElementById('searchingState').style.display = 'block';
            socket.emit('findMatch');
        }
        function cancelSearch() {
            socket.emit('cancelMatch');
            resetPlayMenuUI();
        }

        socket.on('searchingMatch', () => {
            document.getElementById('rankedWaitingRoom').style.display = 'none';
            document.getElementById('searchingState').style.display = 'block';
        });

        socket.on('rankedLobbyUpdate', (data) => {
            document.getElementById('searchingState').style.display = 'none';
            document.getElementById('playMenuGrid').style.display = 'none';
            document.getElementById('customMenuSection').style.display = 'none';
            document.getElementById('rankedWaitingRoom').style.display = 'block';
            currentRoom = data.roomId;
            
            const list = document.getElementById('rankedWaitingPlayers');
            list.innerHTML = '';
            data.players.forEach(p => {
                const status = data.readyStates[p] ? '<span style="color: var(--primary)">Ready</span>' : '<span style="color: var(--text-muted)">Waiting...</span>';
                const info = data.playerDetails ? data.playerDetails[p] : { worldRank: '?', lpRank: '?' };
                
                list.innerHTML += `<li style="margin-bottom: 8px; font-size: 18px; padding: 5px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                    <strong>${p}</strong> <span style="font-size: 14px; color: var(--secondary);">(#${info.worldRank} World | ${info.lpRank})</span> - ${status}
                </li>`;
            });
            
            if(data.readyStates[myUsername]) {
                document.getElementById('readyRankedBtn').style.display = 'none';
            } else {
                document.getElementById('readyRankedBtn').style.display = 'inline-block';
            }
        });

        function readyRanked() { socket.emit('readyRanked', currentRoom); }
        
        function leaveWaitingRoom() { 
            socket.emit('leaveWaitingRoom', currentRoom);
            currentRoom = null;
            resetPlayMenuUI();
        }

        function startAIMatch() { socket.emit('startAIMatch'); }
        
        function createCustomRoom() { 
            const pwd = document.getElementById('customRoomPassword').value;
            socket.emit('createRoom', pwd); 
            document.getElementById('customRoomPassword').value = '';
        }

        function joinCustomRoom(roomId, isLocked) { 
            let pwd = null;
            if (isLocked) {
                pwd = prompt("This room is locked. Enter password:");
                if (pwd === null) return; 
            }
            socket.emit('joinRoom', { roomId: roomId, password: pwd }); 
        }

        function startCustomGame() { if(currentRoom) socket.emit('startCustomGame', currentRoom); }

        socket.on('roomCreated', (roomId) => {
            currentRoom = roomId;
            document.getElementById('roomSetup').style.display = 'block';
            document.getElementById('customRoomIdText').innerText = roomId;
        });

        socket.on('playerJoined', (players) => {
            if(document.getElementById('roomSetup').style.display === 'block') {
                document.getElementById('customPlayerCount').innerText = players.length;
                
                const list = document.getElementById('customWaitingPlayers');
                if (list) {
                    list.innerHTML = '';
                    players.forEach(p => {
                        list.innerHTML += `<li style="margin-bottom: 8px; font-size: 18px; padding: 5px; background: rgba(0,0,0,0.3); border-radius: 5px;"><strong>${p}</strong></li>`;
                    });
                }
            }
        });

        socket.on('roomListUpdate', (rooms) => {
            const list = document.getElementById('roomList');
            list.innerHTML = rooms.length === 0 ? '<p>No open custom rooms.</p>' : '';
            rooms.forEach(r => {
                const lockIcon = r.isLocked ? 'ðŸ”’ ' : '';
                list.innerHTML += `<div style="display:flex; justify-content:space-between; align-items: center; margin-bottom:5px; background: #333; padding: 10px; border-radius: 5px;">
                    <span>${lockIcon}Room: ${r.id} (${r.players}/4)</span>
                    <button class="btn-secondary" onclick="joinCustomRoom('${r.id}', ${r.isLocked})">Join</button>
                </div>`;
            });
        });

        socket.on('roomError', (msg) => { alert(msg); });

        let selectedTiles = [];
        let currentWordStr = "";

        socket.on('gameLoading', (data) => {
            currentRoom = data.roomId;
            document.getElementById('lobbyScreen').classList.remove('active-screen');
            document.getElementById('playMenu').style.display = 'none';
            document.getElementById('loadingPlayers').innerText = "Players: " + data.players.join(' VS ');
            document.getElementById('loadingScreen').style.display = 'flex';
        });

        socket.on('gameStart', (data) => {
            document.getElementById('loadingScreen').style.display = 'none';
            setupGameBoard(data);
        });

        socket.on('rejoinGame', (data) => {
            document.getElementById('authScreen').classList.remove('active-screen');
            setupGameBoard(data);
            
            document.getElementById('myGameScore').innerText = data.myScore;
            data.myWords.forEach(w => {
                document.getElementById('myFoundWordsList').innerHTML += `<li>${w}</li>`;
            });
            const mins = Math.floor(data.time / 60);
            const secs = data.time % 60;
            document.getElementById('gameTimer').innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        });

        function setupGameBoard(data) {
            isSpectator = false;
            currentRoom = data.roomId;
            document.getElementById('gameScreen').classList.add('active-screen');
            document.getElementById('gameControls').style.display = 'flex';
            document.getElementById('myScoreSection').style.display = 'block';
            document.getElementById('spectatorViews').style.display = 'none';
            document.getElementById('gamePlayerList').style.display = 'block';
            document.getElementById('quitGameBtn').style.display = 'block';
            document.getElementById('opponentsTitle').innerText = 'Opponents';
            playGameMusic();
            
            renderBoard(data.board);

            const pList = document.getElementById('gamePlayerList');
            pList.innerHTML = '';
            data.players.forEach(p => {
                if(p !== myUsername) {
                    pList.innerHTML += `<li id="opp_${p}"><strong>${p}</strong>: <span style="color:#aaa; font-style:italic;">Playing...</span></li>`;
                }
            });

            document.getElementById('myGameScore').innerText = '0';
            document.getElementById('myFoundWordsList').innerHTML = '';
            clearWord();
        }

        function renderBoard(boardStr) {
            const boardDiv = document.getElementById('gameBoard');
            boardDiv.innerHTML = '';
            for (let i = 0; i < 36; i++) {
                const tile = document.createElement('div');
                tile.className = 'tile';
                tile.innerText = boardStr[i];
                tile.dataset.index = i;
                tile.onclick = () => { if (!isSpectator) selectTile(tile); };
                boardDiv.appendChild(tile);
            }
        }

        function selectTile(tile) {
            // FIX: Resume audio automatically if browser blocked it on page reload
            if (bgmGame.paused && !isSpectator) playGameMusic();
            
            if (tile.classList.contains('selected')) return;
            tile.classList.add('selected');
            selectedTiles.push(tile);
            currentWordStr += tile.innerText;
            document.getElementById('currentWordDisplay').innerText = currentWordStr;
        }

        function clearWord() {
            selectedTiles.forEach(t => t.classList.remove('selected'));
            selectedTiles = [];
            currentWordStr = "";
            document.getElementById('currentWordDisplay').innerText = "";
            document.getElementById('wordMessage').innerText = "";
        }

        function submitWord() {
            if (currentWordStr.length >= 3) {
                socket.emit('submitWord', { roomId: currentRoom, word: currentWordStr });
            } else {
                document.getElementById('wordMessage').innerText = "Word too short!";
                document.getElementById('wordMessage').style.color = "var(--danger)";
            }
            clearWord();
        }

        socket.on('wordResult', (data) => {
            const msg = document.getElementById('wordMessage');
            if (data.success) {
                msg.innerText = `+${data.points} points!`;
                msg.style.color = "var(--primary)";
                document.getElementById('myFoundWordsList').innerHTML += `<li>${data.word} (+${data.points})</li>`;
                const wordsList = document.getElementById('myScoreSection');
                wordsList.scrollTop = wordsList.scrollHeight;
            } else {
                msg.innerText = "Invalid or already found.";
                msg.style.color = "var(--danger)";
            }
        });

        socket.on('myScoreUpdate', (newScore) => {
            document.getElementById('myGameScore').innerText = newScore;
        });

        socket.on('timeUpdate', (time) => {
            const mins = Math.floor(time / 60);
            const secs = time % 60;
            document.getElementById('gameTimer').innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        });

        function quitGame() {
            if (confirm("Are you sure you want to quit?")) {
                socket.emit('quitMatch', currentRoom);
            }
        }

        socket.on('quitSuccess', (data) => {
            alert(`You have quit the match. Penalty: ${data.penalty} LP.`);
            updateProfileUI(data);
            returnToLobby();
        });

        socket.on('gameOver', (data) => {
            const resultsDiv = document.getElementById('gameOverResults');
            resultsDiv.innerHTML = '';
            
            data.sortedPlayers.forEach((p, index) => {
                const res = data.results[p];
                const lpColor = res.lpChange > 0 ? 'var(--primary)' : (res.lpChange < 0 ? 'var(--danger)' : '#aaa');
                const lpSign = res.lpChange > 0 ? '+' : '';
                
                resultsDiv.innerHTML += `
                <div class="result-row">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-size:20px; font-weight:bold;">#${index + 1}</span>
                        <img src="assets/${res.badge}" style="width:40px; height:40px; object-fit:contain;">
                        <span><strong>${p}</strong> <br> <span style="font-size:12px; color:#aaa;">${res.rank}</span></span>
                    </div>
                    <div style="text-align:right;">
                        <span style="font-size:18px; font-weight:bold;">${res.score} pts</span><br>
                        <span style="color:${lpColor}; font-weight:bold;">${lpSign}${res.lpChange} LP</span>
                    </div>
                </div>`;
                
                if (p === myUsername) {
                    updateProfileUI(res);
                }
            });

            document.getElementById('gameOverModal').style.display = 'flex';
        });

        function resetPlayMenuUI() {
            document.getElementById('searchingState').style.display = 'none';
            document.getElementById('rankedWaitingRoom').style.display = 'none';
            document.getElementById('playMenuGrid').style.display = 'grid';
            document.getElementById('customMenuSection').style.display = 'block';
            document.getElementById('roomSetup').style.display = 'none';
        }

        function returnToLobby() {
            document.getElementById('gameOverModal').style.display = 'none';
            document.getElementById('gameScreen').classList.remove('active-screen');
            document.getElementById('lobbyScreen').classList.add('active-screen');
            currentRoom = null;
            
            resetPlayMenuUI();
            document.getElementById('playMenu').style.display = 'none';
            
            playMenuMusic();
            socket.emit('getLeaderboard');
        }

        function openAdminPanel() {
            document.getElementById('adminPanel').style.display = 'flex';
            socket.emit('requestAdminData');
        }
        function closeAdminPanel() {
            document.getElementById('adminPanel').style.display = 'none';
        }
        function adminBroadcast() {
            const msg = document.getElementById('adminBroadcastInput').value;
            if(msg) { socket.emit('adminBroadcast', msg); document.getElementById('adminBroadcastInput').value = ''; }
        }
        function adminKick(user) { socket.emit('adminKick', user); }
        function adminSpectate(roomId) { socket.emit('adminSpectate', roomId); closeAdminPanel(); }

        socket.on('adminDataUpdate', (data) => {
            if (myUsername !== 'Kei') return;
            const uList = document.getElementById('adminUserList');
            uList.innerHTML = '';
            data.users.forEach(u => {
                uList.innerHTML += `<div class="admin-item"><span>${u}</span> <button class="btn-danger" style="padding:5px;" onclick="adminKick('${u}')">Kick</button></div>`;
            });

            const rList = document.getElementById('adminRoomList');
            rList.innerHTML = '';
            data.rooms.forEach(r => {
                rList.innerHTML += `<div class="admin-item">
                    <span style="font-size:12px;">${r.id}<br>${r.players.join(', ')}<br>Time: ${r.time}s</span> 
                    <button class="btn-secondary" style="padding:5px;" onclick="adminSpectate('${r.id}')">Spectate</button>
                </div>`;
            });
        });

        socket.on('spectateStart', (data) => {
            isSpectator = true;
            currentRoom = data.roomId;
            document.getElementById('lobbyScreen').classList.remove('active-screen');
            document.getElementById('gameScreen').classList.add('active-screen');
            
            document.getElementById('gameControls').style.display = 'none';
            document.getElementById('myScoreSection').style.display = 'none';
            document.getElementById('gamePlayerList').style.display = 'none';
            document.getElementById('quitGameBtn').style.display = 'none';
            document.getElementById('opponentsTitle').innerText = 'Spectating Mode';
            
            const specViews = document.getElementById('spectatorViews');
            specViews.style.display = 'grid';
            specViews.innerHTML = '';
            
            data.players.forEach(p => {
                specViews.innerHTML += `
                <div class="spec-player" id="specBox_${p}">
                    <strong>${p}</strong> - <span id="specScore_${p}">0</span> pts
                    <div class="spec-words" id="specWords_${p}"></div>
                </div>`;
            });

            renderBoard(data.board);
        });

        socket.on('spectatorUpdate', (data) => {
            if (!isSpectator) return;
            const scoreSpan = document.getElementById(`specScore_${data.player}`);
            const wordsDiv = document.getElementById(`specWords_${data.player}`);
            
            if (scoreSpan && wordsDiv) {
                const currentScore = parseInt(scoreSpan.innerText) || 0;
                scoreSpan.innerText = currentScore + data.points;
                wordsDiv.innerHTML += `<div>${data.word} (+${data.points})</div>`;
                wordsDiv.scrollTop = wordsDiv.scrollHeight;
            }
        });
    </script>
</body>
</html>
