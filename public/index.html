<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Per Word</title>
    <style>
        :root {
            --bg-color: #1a1a24; --panel-bg: #2a2a35; --primary: #4CAF50;
            --secondary: #2196F3; --danger: #f44336; --text-light: #f1f1f1;
            --text-muted: #aaa; --grid-bg: #333; --tile-bg: #e0e0e0;
            --tile-text: #111; --tile-selected: #ffc107;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); color: var(--text-light); margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        .container { width: 100%; max-width: 1100px; background-color: var(--panel-bg); border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); overflow: hidden; display: none; flex-direction: column; height: 90vh; }
        .active-screen { display: flex; }
        
        /* Auth */
        .auth-box { margin: auto; text-align: center; padding: 40px; background-color: rgba(0,0,0,0.2); border-radius: 10px; }
        .auth-box h1 { margin-bottom: 20px; color: var(--primary); }
        .auth-box input { display: block; width: 80%; margin: 10px auto; padding: 10px; border-radius: 5px; border: none; }
        
        /* Buttons */
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-secondary { background-color: var(--secondary); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-admin { background-color: #9c27b0; color: white; display: none; }
        button:hover { opacity: 0.8; }
        
        /* Lobby */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background-color: #222; border-bottom: 2px solid var(--primary); }
        .profile-info { display: flex; align-items: center; gap: 15px; }
        .profile-text h3 { margin: 0; }
        .profile-text p { margin: 5px 0 0 0; color: var(--text-muted); font-size: 14px; }
        .rank-badge { width: 50px; height: 50px; object-fit: contain; }
        .lobby-content { display: flex; flex: 1; overflow: hidden; }
        .left-panel { flex: 2; padding: 20px; display: flex; flex-direction: column; gap: 15px; border-right: 1px solid #444; overflow-y: auto;}
        .right-panel { flex: 1; display: flex; flex-direction: column; background-color: #1f1f28; }
        
        /* Play Now Menu */
        .play-menu { display: none; background: rgba(0,0,0,0.4); padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        
        /* Leaderboard */
        .leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 10px; background: rgba(0,0,0,0.2); border-radius: 5px; overflow: hidden;}
        .leaderboard-table th, .leaderboard-table td { padding: 10px; text-align: left; border-bottom: 1px solid #444; vertical-align: middle; }
        .leaderboard-table th { background-color: #111; color: var(--secondary); }
        .badge-cell { width: 60px; text-align: center; }

        /* Chat */
        .chat-box { flex: 1; display: flex; flex-direction: column; padding: 10px; }
        .chat-messages { flex: 1; overflow-y: auto; margin-bottom: 10px; padding: 10px; background-color: rgba(0,0,0,0.3); border-radius: 5px; font-size: 14px; }
        .chat-input-area { display: flex; }
        .chat-input-area input { flex: 1; padding: 10px; border-radius: 5px 0 0 5px; border: none; }
        .chat-input-area button { margin: 0; border-radius: 0 5px 5px 0; }
        
        /* Game */
        .game-layout { display: flex; flex: 1; padding: 20px; gap: 20px; }
        .board-section { flex: 2; display: flex; flex-direction: column; align-items: center; }
        .grid-6x6 { display: grid; grid-template-columns: repeat(6, 60px); grid-template-rows: repeat(6, 60px); gap: 5px; background-color: var(--grid-bg); padding: 10px; border-radius: 8px; margin-bottom: 20px; user-select: none; }
        .tile { background-color: var(--tile-bg); color: var(--tile-text); font-size: 24px; font-weight: bold; display: flex; justify-content: center; align-items: center; border-radius: 4px; cursor: pointer; box-shadow: 0 4px 0px #999; }
        .tile.selected { background-color: var(--tile-selected); box-shadow: 0 2px 0px #b28704; transform: translateY(2px); }
        .word-builder { display: flex; gap: 10px; align-items: center; }
        .current-word { font-size: 24px; letter-spacing: 2px; min-width: 150px; text-align: center; padding: 10px; background: #111; border-radius: 5px; }
        .side-section { flex: 1; display: flex; flex-direction: column; gap: 15px; }
        .player-list, .found-words { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; overflow-y: auto; }
        .found-words { flex: 1; }
        .timer { font-size: 32px; font-weight: bold; color: var(--danger); text-align: center; }
        
        /* Game Over Modal */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; }
        .modal-content { background-color: var(--panel-bg); padding: 30px; border-radius: 10px; text-align: center; width: 80%; max-width: 600px; }
        .result-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #444; }
        
        /* Admin Panel */
        #adminPanel { display: none; position: absolute; top: 10%; left: 10%; width: 80%; height: 80%; background: #1a1a24; border: 2px solid #9c27b0; border-radius: 10px; z-index: 200; flex-direction: column; padding: 20px; box-shadow: 0 0 20px #9c27b0; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #9c27b0; padding-bottom: 10px; margin-bottom: 15px; }
        .admin-body { display: flex; gap: 20px; flex: 1; overflow: hidden; }
        .admin-col { flex: 1; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; overflow-y: auto; }
        .admin-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #444; align-items: center; }
    </style>
</head>
<body>
    <audio id="bgmMenu" src="music/menu.mp3" loop></audio>
    <audio id="bgmGame" src="music/gameplay.mp3" loop></audio>

    <div id="authScreen" class="container active-screen">
        <div class="auth-box">
            <h1>Word Per Word</h1>
            <input type="text" id="usernameInput" placeholder="Username" />
            <input type="password" id="passwordInput" placeholder="Password" />
            <button class="btn-primary" onclick="login()">Login</button>
            <button class="btn-secondary" onclick="register()">Register</button>
            <p id="authMessage" style="color: var(--danger);"></p>
        </div>
    </div>

    <div id="lobbyScreen" class="container">
        <div class="header">
            <div class="profile-info">
                <img id="headerBadge" class="rank-badge" src="assets/e.png" alt="Rank Badge">
                <div class="profile-text">
                    <h3 id="profileUsername">Player</h3>
                    <p><span id="profileRank">Novice Scribe</span> | LP: <span id="profileLp">0</span></p>
                </div>
            </div>
            <div>
                <button id="adminBtn" class="btn-admin" onclick="openAdminPanel()">Admin Panel</button>
                <button class="btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>
        
        <div class="lobby-content">
            <div class="left-panel">
                <button class="btn-primary" style="font-size: 20px; padding: 15px;" onclick="togglePlayMenu()">PLAY NOW</button>
                
                <div id="playMenu" class="play-menu">
                    <button class="btn-secondary" onclick="findMatch()">Find Ranked Match</button>
                    <button class="btn-primary" onclick="createCustomRoom()">Create Custom Room</button>
                    <hr style="border-color: #444; margin: 15px 0;">
                    <h4>Active Custom Rooms</h4>
                    <div id="roomList" style="text-align: left;"></div>
                    <div id="roomSetup" style="display:none; background: #222; padding: 15px; border-radius: 5px; margin-top: 10px;">
                        <h3>Custom Room: <span id="customRoomIdText"></span></h3>
                        <p>Players: <span id="customPlayerCount">1</span>/4</p>
                        <button class="btn-primary" onclick="startCustomGame()">Start Game</button>
                    </div>
                </div>

                <h2>World Ranking</h2>
                <table class="leaderboard-table">
                    <thead><tr><th class="badge-cell">Badge</th><th>Player</th><th>Rank</th><th>LP</th></tr></thead>
                    <tbody id="leaderboardBody"></tbody>
                </table>
            </div>
            
            <div class="right-panel">
                <div class="chat-box">
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-input-area">
                        <input type="text" id="chatInput" placeholder="Type a message..." onkeypress="handleChatEnter(event)">
                        <button class="btn-primary" onclick="sendChat()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="gameScreen" class="container">
        <div class="game-layout">
            <div class="board-section">
                <div class="timer" id="gameTimer">2:00</div>
                <div class="grid-6x6" id="gameBoard"></div>
                <div class="word-builder">
                    <div class="current-word" id="currentWordDisplay"></div>
                    <button class="btn-primary" onclick="submitWord()">Submit</button>
                    <button class="btn-secondary" onclick="clearWord()">Clear</button>
                </div>
                <p id="wordMessage" style="margin-top: 10px; font-weight: bold;"></p>
            </div>
            
            <div class="side-section">
                <div class="player-list">
                    <h3>Opponents</h3>
                    <ul id="gamePlayerList" style="list-style: none; padding: 0;"></ul>
                </div>
                <div class="found-words">
                    <h3>My Score: <span id="myGameScore">0</span></h3>
                    <ul id="myFoundWordsList" style="list-style: none; padding: 0; color: var(--secondary);"></ul>
                </div>
            </div>
        </div>
    </div>

    <div id="gameOverModal" class="modal">
        <div class="modal-content">
            <h1 style="color: var(--primary);">Time's Up!</h1>
            <h2>Final Results</h2>
            <div id="gameOverResults" style="margin-top: 20px; text-align: left;"></div>
            <button class="btn-primary" style="margin-top: 20px;" onclick="returnToLobby()">Return to Lobby</button>
        </div>
    </div>

    <div id="adminPanel">
        <div class="admin-header">
            <h2>Admin Control Panel (Kei)</h2>
            <button class="btn-danger" onclick="closeAdminPanel()">Close X</button>
        </div>
        <div style="margin-bottom: 15px; display: flex;">
            <input type="text" id="adminBroadcastInput" placeholder="System Broadcast Message..." style="flex: 1; padding: 10px;">
            <button class="btn-secondary" onclick="adminBroadcast()">Broadcast</button>
        </div>
        <div class="admin-body">
            <div class="admin-col">
                <h3>Online Users</h3>
                <div id="adminUserList"></div>
            </div>
            <div class="admin-col">
                <h3>Active Matches</h3>
                <div id="adminRoomList"></div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentRoom = null;
        let myUsername = null;

        // BGM Handling
        const bgmMenu = document.getElementById('bgmMenu');
        const bgmGame = document.getElementById('bgmGame');
        bgmMenu.volume = 0.5;
        bgmGame.volume = 0.5;

        function playMenuMusic() {
            bgmGame.pause(); bgmGame.currentTime = 0;
            bgmMenu.play().catch(e => console.log("Audio play blocked until interaction."));
        }
        function playGameMusic() {
            bgmMenu.pause(); bgmMenu.currentTime = 0;
            bgmGame.play().catch(e => console.log("Audio play blocked until interaction."));
        }

        // --- Auth ---
        function register() {
            const u = document.getElementById('usernameInput').value;
            const p = document.getElementById('passwordInput').value;
            if(u && p) socket.emit('register', {username: u, password: p});
        }
        function login() {
            const u = document.getElementById('usernameInput').value;
            const p = document.getElementById('passwordInput').value;
            if(u && p) socket.emit('login', {username: u, password: p});
        }
        function logout() {
            socket.emit('logout');
            myUsername = null;
            document.getElementById('authScreen').classList.add('active-screen');
            document.getElementById('lobbyScreen').classList.remove('active-screen');
            bgmMenu.pause();
        }

        socket.on('authSuccess', (data) => {
            myUsername = data.username;
            document.getElementById('authMessage').innerText = '';
            document.getElementById('authScreen').classList.remove('active-screen');
            document.getElementById('lobbyScreen').classList.add('active-screen');
            
            document.getElementById('profileUsername').innerText = data.username;
            document.getElementById('profileRank').innerText = data.rank;
            document.getElementById('profileLp').innerText = data.lp;
            document.getElementById('headerBadge').src = `assets/${data.badge}`;
            
            if (myUsername === 'Kei') document.getElementById('adminBtn').style.display = 'inline-block';
            else document.getElementById('adminBtn').style.display = 'none';

            playMenuMusic();
            socket.emit('getLeaderboard');
            socket.emit('getRoomList');
        });

        socket.on('authError', (msg) => document.getElementById('authMessage').innerText = msg);
        socket.on('adminKicked', () => { alert("You have been kicked by the Admin."); window.location.reload(); });
        socket.on('serverBroadcast', (msg) => { alert("SERVER BROADCAST: " + msg); });

        // --- Lobby & Chat ---
        function sendChat() {
            const input = document.getElementById('chatInput');
            if (input.value.trim()) {
                socket.emit('sendChat', input.value.trim());
                input.value = '';
            }
        }
        function handleChatEnter(e) { if(e.key === 'Enter') sendChat(); }
        
        socket.on('receiveChat', (data) => {
            const box = document.getElementById('chatMessages');
            box.innerHTML += `<div><strong>[${data.rank}] ${data.username}:</strong> ${data.message}</div>`;
            box.scrollTop = box.scrollHeight;
        });

        socket.on('updateLeaderboard', (players) => {
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = '';
            players.forEach(p => {
                tbody.innerHTML += `<tr>
                    <td class="badge-cell"><img class="rank-badge" src="assets/${p.badge}" alt="Badge"></td>
                    <td><strong>${p.username}</strong></td>
                    <td>${p.rank}</td>
                    <td>${p.lp}</td>
                </tr>`;
            });
        });

        // --- Play Now Menu ---
        function togglePlayMenu() {
            const menu = document.getElementById('playMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            if (menu.style.display === 'block') socket.emit('getRoomList');
        }

        function findMatch() {
            socket.emit('findMatch');
            document.getElementById('playMenu').innerHTML = '<h3>Searching for players...</h3>';
        }
        function createCustomRoom() { socket.emit('createRoom'); }
        function joinCustomRoom(roomId) { socket.emit('joinRoom', roomId); }
        function startCustomGame() { if(currentRoom) socket.emit('startCustomGame', currentRoom); }

        socket.on('roomCreated', (roomId) => {
            currentRoom = roomId;
            document.getElementById('roomSetup').style.display = 'block';
            document.getElementById('customRoomIdText').innerText = roomId;
        });

        socket.on('playerJoined', (players) => {
            if(document.getElementById('roomSetup').style.display === 'block') {
                document.getElementById('customPlayerCount').innerText = players.length;
            }
        });

        socket.on('roomListUpdate', (rooms) => {
            const list = document.getElementById('roomList');
            list.innerHTML = rooms.length === 0 ? '<p>No open custom rooms.</p>' : '';
            rooms.forEach(r => {
                list.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:5px; background: #333; padding: 10px; border-radius: 5px;">
                    <span>Room: ${r.id} (${r.players}/4)</span>
                    <button class="btn-secondary" onclick="joinCustomRoom('${r.id}')">Join</button>
                </div>`;
            });
        });

        // --- Gameplay ---
        let selectedTiles = [];
        let currentWordStr = "";

        socket.on('gameStart', (data) => {
            currentRoom = data.roomId;
            document.getElementById('lobbyScreen').classList.remove('active-screen');
            document.getElementById('gameScreen').classList.add('active-screen');
            document.getElementById('playMenu').style.display = 'none';
            playGameMusic();
            
            // Build Board
            const boardDiv = document.getElementById('gameBoard');
            boardDiv.innerHTML = '';
            for (let i = 0; i < 36; i++) {
                const tile = document.createElement('div');
                tile.className = 'tile';
                tile.innerText = data.board[i];
                tile.dataset.index = i;
                tile.onclick = () => selectTile(tile);
                boardDiv.appendChild(tile);
            }

            // Hide opponent scores, just show names
            const pList = document.getElementById('gamePlayerList');
            pList.innerHTML = '';
            data.players.forEach(p => {
                if(p !== myUsername) {
                    pList.innerHTML += `<li id="opp_${p}"><strong>${p}</strong>: <span style="color:#aaa; font-style:italic;">Playing...</span></li>`;
                }
            });

            document.getElementById('myGameScore').innerText = '0';
            document.getElementById('myFoundWordsList').innerHTML = '';
            clearWord();
        });

        function selectTile(tile) {
            if (tile.classList.contains('selected')) return;
            tile.classList.add('selected');
            selectedTiles.push(tile);
            currentWordStr += tile.innerText;
            document.getElementById('currentWordDisplay').innerText = currentWordStr;
        }

        function clearWord() {
            selectedTiles.forEach(t => t.classList.remove('selected'));
            selectedTiles = [];
            currentWordStr = "";
            document.getElementById('currentWordDisplay').innerText = "";
            document.getElementById('wordMessage').innerText = "";
        }

        function submitWord() {
            if (currentWordStr.length >= 3) {
                socket.emit('submitWord', { roomId: currentRoom, word: currentWordStr });
            } else {
                document.getElementById('wordMessage').innerText = "Word too short!";
                document.getElementById('wordMessage').style.color = "var(--danger)";
            }
            clearWord();
        }

        socket.on('wordResult', (data) => {
            const msg = document.getElementById('wordMessage');
            if (data.success) {
                msg.innerText = `+${data.points} points!`;
                msg.style.color = "var(--primary)";
                document.getElementById('myFoundWordsList').innerHTML += `<li>${data.word} (+${data.points})</li>`;
            } else {
                msg.innerText = "Invalid or already found.";
                msg.style.color = "var(--danger)";
            }
        });

        // Only updates YOUR score visually
        socket.on('myScoreUpdate', (newScore) => {
            document.getElementById('myGameScore').innerText = newScore;
        });

        socket.on('timeUpdate', (time) => {
            const mins = Math.floor(time / 60);
            const secs = time % 60;
            document.getElementById('gameTimer').innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        });

        // --- Game Over ---
        socket.on('gameOver', (data) => {
            const resultsDiv = document.getElementById('gameOverResults');
            resultsDiv.innerHTML = '';
            
            data.sortedPlayers.forEach((p, index) => {
                const res = data.results[p];
                const lpColor = res.lpChange > 0 ? 'var(--primary)' : (res.lpChange < 0 ? 'var(--danger)' : '#aaa');
                const lpSign = res.lpChange > 0 ? '+' : '';
                
                resultsDiv.innerHTML += `
                <div class="result-row">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-size:20px; font-weight:bold;">#${index + 1}</span>
                        <img src="assets/${res.badge}" style="width:40px; height:40px; object-fit:contain;">
                        <span><strong>${p}</strong> <br> <span style="font-size:12px; color:#aaa;">${res.rank}</span></span>
                    </div>
                    <div style="text-align:right;">
                        <span style="font-size:18px; font-weight:bold;">${res.score} pts</span><br>
                        <span style="color:${lpColor}; font-weight:bold;">${lpSign}${res.lpChange} LP</span>
                    </div>
                </div>`;
                
                // Update local profile if it's you
                if (p === myUsername) {
                    document.getElementById('profileRank').innerText = res.rank;
                    document.getElementById('profileLp').innerText = res.newLp;
                    document.getElementById('headerBadge').src = `assets/${res.badge}`;
                }
            });

            document.getElementById('gameOverModal').style.display = 'flex';
        });

        function returnToLobby() {
            document.getElementById('gameOverModal').style.display = 'none';
            document.getElementById('gameScreen').classList.remove('active-screen');
            document.getElementById('lobbyScreen').classList.add('active-screen');
            currentRoom = null;
            document.getElementById('roomSetup').style.display = 'none';
            
            playMenuMusic();
            socket.emit('getLeaderboard');
        }

        // --- Admin Panel ---
        function openAdminPanel() {
            document.getElementById('adminPanel').style.display = 'flex';
            socket.emit('requestAdminData');
        }
        function closeAdminPanel() {
            document.getElementById('adminPanel').style.display = 'none';
        }
        function adminBroadcast() {
            const msg = document.getElementById('adminBroadcastInput').value;
            if(msg) { socket.emit('adminBroadcast', msg); document.getElementById('adminBroadcastInput').value = ''; }
        }
        function adminKick(user) { socket.emit('adminKick', user); }
        function adminSpectate(roomId) { socket.emit('adminSpectate', roomId); closeAdminPanel(); }

        socket.on('adminDataUpdate', (data) => {
            if (myUsername !== 'Kei') return;
            const uList = document.getElementById('adminUserList');
            uList.innerHTML = '';
            data.users.forEach(u => {
                uList.innerHTML += `<div class="admin-item"><span>${u}</span> <button class="btn-danger" style="padding:5px;" onclick="adminKick('${u}')">Kick</button></div>`;
            });

            const rList = document.getElementById('adminRoomList');
            rList.innerHTML = '';
            data.rooms.forEach(r => {
                rList.innerHTML += `<div class="admin-item">
                    <span style="font-size:12px;">${r.id}<br>${r.players.join(', ')}<br>Time: ${r.time}s</span> 
                    <button class="btn-secondary" style="padding:5px;" onclick="adminSpectate('${r.id}')">Spectate</button>
                </div>`;
            });
        });

        socket.on('spectateStart', (data) => {
            // Basic hook to view a board as Admin (can be expanded later)
            alert("Spectating Room: " + data.roomId + "\nPlayers: " + data.players.join(', '));
        });

    </script>
</body>
</html>
